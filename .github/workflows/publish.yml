name: CI and Publish

on:
  push:
    branches:
      - main
#   release:
#     types: [published]

jobs:
#   test:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v2

#       - name: Set up Dart
#         uses: dart-lang/setup-dart@v1
#         with:
#           sdk: 'stable'

#       - name: Install dependencies
#         run: dart pub get

#       - name: Run tests
#         run: dart test

  publish:
    runs-on: ubuntu-latest
    # needs: test
    # if: github.event_name == 'release'
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: 'stable'

      - name: Install dependencies
        run: dart pub get

      - name: Publish package
        env:
          PUB_DEV_TOKEN: ${{ secrets.PUB_DEV_TOKEN }}
        run: |
          # Create the credentials file for pub.dev
          echo "//pub.dev: _token=${PUB_CREDENTIALS}" > ~/.pub-cache/credentials.json
          
          # Optional: Test publishing
          dart pub publish --dry-run
          
          # Publish the package
          dart pub publish --force
