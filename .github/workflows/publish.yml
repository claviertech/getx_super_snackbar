name: CI and Publish

on:
  push:
    branches:
      - main
#   release:
#     types: [published]

jobs:
#   test:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v2

#       - name: Set up Dart
#         uses: dart-lang/setup-dart@v1
#         with:
#           sdk: 'stable'

#       - name: Install dependencies
#         run: dart pub get

#       - name: Run tests
#         run: dart test

  publish:
    runs-on: ubuntu-latest
    # needs: test
    # if: github.event_name == 'release'
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version-resolver: 'stable'  # Specify the Flutter version

      - name: Install dependencies
        run: flutter pub get  # Use flutter pub instead of dart pub

      - name: Publish package
        env:
          PUB_DEV_TOKEN: ${{ secrets.PUB_CREDENTIALS }}
        run: |
          # Create the credentials file for pub.dev
          echo "//pub.dev: _token=${PUB_DEV_TOKEN}" > ~/.pub-cache/credentials.json
          
          # Optional: Test publishing
          flutter pub publish --dry-run  # Use flutter pub instead of dart pub
          
          # Publish the package
          flutter pub publish --force  # Use flutter pub instead of dart pub
